# Q161 为什么我向某客户的 TSP 系统发送 POST 请求一直失败

## 版本说明

| 时间 | 版本 | 说明 |
| ---- | ---- | ---- |
| 2023-12-06 | 1.0 | 初稿 |

## 问题

工作中遇到一个需求，需要把一些数据上传到某客户的 TSP 系统。
为保证通信安全、防止服务接口被恶意攻击，客户的 TSP 系统对 API 进行约束，
要求使用 API 时，需要计算一个签名 sign，与其他一些认证信息共同填到 Header 中。

我开发完代码后，自测时发现客户的 TSP 系统一直返回 HTTP 状态码 403 以及错误提示信息「系统内部异常」。

## 解答

### 打印签名计算过程

首先怀疑签名计算有误，因为这是整个需求中最复杂的一环。
因此在日志里增加调试信息以打印中间计算结果，但没发现异常。

### 打印 Header

接着怀疑 Header 设置有误，因此打印 Header 各字段。
Go 的 `net/http` package 的 `Request` 结构体的 `Header` 字段的类型是 `map[string][]string`，
在打印 Header 时，发现 map 的每个 key 首字母都变成大写了——在设置 Header 时本来有些字段是小写的。

由于客户的文档里提到过「Header字段的参数全部转换为小写」，因此这里引起我的怀疑。
我在 [stack overflow][1] 查了一下，得知请求头的字段名字是大小写不敏感的，因此认为这是个无关因素。
同时，我潜意识里还有另外一个想法：也许这只是 Go 在打印 map 时才自动将字段首字母打印为大学的，Header 字段在通信时还是会保留小写。

### 对比 Python 程序

由于同事之前使用 Python 实现过同样的功能，于是我将同事的 Python 代码从对应仓库中抽离出来单独运行，结果可以正常 POST！
我既惊又喜，惊的是没想到 Python 代码能够一次就跑通，喜的是有了成功的 Python 代码作为对照，更有利于我排查 Go 代码的问题。

首先，我尝试故意将 Python 代码改错，比如删除签名，或者把签名改错，测试运行结果，发现这时会报「签名不一致」的错误。
这启示我：Go 代码的错误不关签名的事情。

然后，我尝试把 request body 的内容删减甚至清空，这时报的错误也跟 Go 代码的错误不一样。
这也启示我：Go 代码的错误不关 request body 的事情。

那么，只能是 request header 的问题。于是我把重新再次放在检查 Header 里面。

### 再次检查 Header

继续增加打印信息、对比 Go 与 Python 的运行结果，还是找不到思路。
最后，我终于又怀疑起 Header 字段大小写的问题了。
参考 [stack overflow][2] 的回答，我自己定义了一个类型为 `map[string][]string` 的 变量，并将其赋值给 `Request.Header`。
再次运行，这次终于成功了。原来就是 Go 的 `net/http` 的 `Request.Header` 自动将字段首字母的变大写导致的问题！

## 总结

首先总结 Go 的 `net/http` 的这一奇怪特性：`Request.Header` 会自动将字段的首字母转为大写。

然后总结问题定位的方法论。
找到问题原因后，会觉得这个问题很简单，但事实上这个问题耗费我大约4小时，这是为什么呢？

其实，我这次问题定位的思路大体上是没问题的：找成功的案例来对比、逐步缩小排查范围。
我犯的主要错误在于：一开始放过了请求头字段首字母大写的问题，在错误的方向走了很久，才回头找到正确的方向。

教训：定位问题时，不要轻易放过每一个怀疑点。要「大胆假设，小心求证」。不要焦急，也不要想当然。

  [1]: https://stackoverflow.com/questions/5258977/are-http-headers-case-sensitive
  [2]: https://stackoverflow.com/a/24945983

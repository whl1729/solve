# Q160 为什么我的 WSL2 Ubuntu 无法访问 Windows 的网络代理了

## 版本说明

| 时间 | 版本 | 说明 |
| ---- | ---- | ---- |
| 2023-12-04 | 1.0 | 初稿 |

## 解答

### 检查 host IP

根据[微软官网][1]的教程，WSL 访问 host 网络时，使用的 IP 应该为 `/etc/resolv.conf` 文件里配置的 IP。
但我之前使用这个 IP 一直无法正常工作，反而是直接使用 host 的无线网络的IP可以正常工作。

当然，出问题后，我还是确认一下 host IP 是否搞错了。于是我反复试用这两个 IP，均无法工作。因此排除是 IP 的问题。

### 检查 Shadowsocks

接下来排查主机使用的网络代理 Shadowssocks 配置有问题。
检查到「允许其他设备连入」已经打开，并且端口确实为 1080，似乎没啥问题。
重启 Shadowsocks 后现象不变，因此排除是 Shadowsocks 的问题。

### 检查网络配置

首先检查防火墙配置，打开「防火墙和网络保护」页面，看到「域网络」、「专用网络」和「公用网络」下面均写着「无需执行任何操作」，
那防火墙应该没有问题。

在「代理」页面，看到「自动设置代理」的「使用设置脚本」的按钮是打开的，于是将其关闭，但现象不变，所以应该不关这个按钮的事。

### 使用 telnet 测试端口连接性

接下来，我在 WSL 里面使用 telnet 命令测试能否连接 host 的 1080 端口，结果是不能。
然后我又在 host 使用 `python -m http.server` 监听端口 8000， 在 WSL 里面 telnet 8000，仍然不能。

作为对比，我在 host 里面 telnet 自身的 1080 或 8000 端口，都能连通。

然后我决定在另一台电脑重复 telnet 实验，以确认是否只有在 WSL 里面才会有 telnet 不通的问题。
结果是：在另一台电脑上，仍然无法 telnet host 的 8000 端口，而反过来则可以，在 host 可以 telnet 另一台电脑的 8000 端口。

### 检查端口映射

这时我想起来之前在 host 配置过一些端口映射规则，于是使用 `netsh interface portproxy show all` 检查一下，发现没有映射规则。

### 关闭「火绒终端安全管理系统」

我们公司在所有人的电脑上都安装了「火绒终端安全管理系统」，我怀疑是火绒搞的鬼，于是把它关闭，但现象不变。

### 再次检查防火墙

这时我重新怀疑是否防火墙没关闭，于是使用 `netsh advfirewall show allprofiles` 检查一下，
输出结果分为「域配置文件 设置」、「专用配置文件 设置」、「公用配置文件 设置」三部分，看不太懂。
在网上找到一条关闭所有防火墙的命令 `netsh advfirewall set allprofiles state off`，
执行之后，再测试，发现终于可以 telnet 通了。

这时我重新对比关闭防火墙前后的防火墙配置，发现关闭前，「公用配置文件 设置」的「状态」是「启用」的；
关闭后，该「状态」就变为「关闭」了。

而如果在「防火墙和网络保护」页面，点击「公用网络」，「Microsoft Defender 防火墙」下面显示的信息是：

「Microsoft Defender 防火墙处于非活动状态，因为你正在使用其他提供程序」。

这里的「其他提供程序」应该就是指「火绒安全软件」。

总之，问题的原因还是防火墙的问题，具体细节就不清楚了。

  [1]: https://learn.microsoft.com/en-us/windows/wsl/networking
